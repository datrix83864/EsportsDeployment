---
# Consolidated Deployment Playbook - FIXED VERSION
# Addresses cloud-init and network configuration issues
#
# Usage:
#   ansible-playbook -i inventory/proxmox deploy.yml -e @../config.yaml

- name: Provision VMs on Proxmox
  import_playbook: provision.yml
  tags: ['provision']

# Phase 2: Configure PXE Server

- name: Configure PXE Server
  import_playbook: pxe.yml
  tags: ['pxe']

# Phase 3: Configure LANCache Server
- name: Configure LANCache Server
  import_playbook: lancache.yml
  tags: ['lancache']

# Phase 4: Configure File Server
- name: Configure File Server
  import_playbook: fileserver.yml
  tags: ['fileserver']

# Phase 5: Verification
- name: Verify Deployment
  hosts: localhost
  gather_facts: false
  
  tasks:
    - name: Final connectivity test
      wait_for:
        host: "{{ item }}"
        port: 22
        timeout: 30
      loop:
        - "{{ network.pxe_server }}"
        - "{{ network.lancache_server }}"
        - "{{ network.file_server }}"
    
    - name: Display verification results
      debug:
        msg:
          - "═══════════════════════════════════════════"
          - "Deployment Complete!"
          - "═══════════════════════════════════════════"
          - ""
          - "All VMs are up and accessible via SSH"
          - ""
          - "Next steps:"
          - "  1. Check service status on each VM"
          - "  2. Test PXE boot from a client"
          - "  3. Configure user accounts on file server"
          - ""