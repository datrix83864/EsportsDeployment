- name: Deploy Esports LAN Infrastructure
  hosts: localhost
  gather_facts: false

  vars_files:
    - ../config.yaml  # root-level config

  pre_tasks:
    - name: Verify SSH key exists
      stat:
        path: "{{ lookup('env','HOME') }}/.ssh/id_rsa.pub"
      register: ssh_key_check
      failed_when: not ssh_key_check.stat.exists

    - name: Display SSH key status
      debug:
        msg: "SSH key found: {{ lookup('env','HOME') }}/.ssh/id_rsa.pub"

  tasks:
    - name: Set global facts from config.yaml
      set_fact:
        proxmox_host: "{{ proxmox.host }}"
        proxmox_user: "{{ proxmox.user }}"
        proxmox_password: "{{ proxmox.password }}"
        proxmox_api_token_id: "{{ proxmox.api_token_id }}"
        proxmox_api_token_secret: "{{ proxmox.api_token_secret }}"
        proxmox_node: "{{ proxmox.node }}"
        proxmox_storage: "{{ proxmox.storage }}"
        cloud_template_name: "ubuntu-cloud"
        cloud_template_vmid: 105
        cloud_image_url: "https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img"
        cloud_image_path: "/tmp/jammy-server-cloudimg-amd64.img"
        ssh_public_key: "{{ lookup('file', lookup('env','HOME') + '/.ssh/id_rsa.pub') }}"

    - name: Generate VM definitions dynamically from resources
      set_fact:
        vms: "{{ vms | default([]) + [ {'name': item.key,
                                        'vmid': loop.index0 + 100,
                                        'ip': network[item.key],
                                        'memory': item.value.memory,
                                        'cores': item.value.cores,
                                        'disk': item.value.disk,
                                        'extra_disk': item.value.cache_disk | default(item.value.data_disk | default(omit)),
                                        'role': item.key.split('_')[0]} ] }}"
      loop: "{{ resources|dict2items }}"
      loop_control:
        index_var: loop_index


# Imported playbooks
- import_playbook: provision/display_deployment_info.yml
- import_playbook: provision/template.yml
- import_playbook: provision/clone_vms.yml
- import_playbook: provision/wait_for_ssh.yml
- import_playbook: provision/update_dns.yml
- import_playbook: provision/install_agent.yml
- import_playbook: provision/build_inventory.yml
