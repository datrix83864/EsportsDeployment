- name: Deploy Esports LAN Infrastructure
  hosts: localhost
  gather_facts: false

  vars_files:
    - ../config.yaml

  pre_tasks:
    - name: Verify SSH key exists
      stat:
        path: "{{ lookup('env','HOME') }}/.ssh/id_rsa.pub"
      register: ssh_key_check
      failed_when: not ssh_key_check.stat.exists

    - name: Display SSH key status
      debug:
        msg: "SSH key found: {{ lookup('env','HOME') }}/.ssh/id_rsa.pub"

  tasks:
    - name: Set VM facts for this run
      set_fact:
        cloud_template_name: "ubuntu-cloud"
        cloud_template_vmid: 105
        cloud_image_url: https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img
        cloud_image_path: /tmp/jammy-server-cloudimg-amd64.img
        ssh_public_key: "{{ lookup('file', lookup('env','HOME') + '/.ssh/id_rsa.pub') }}"

        # VM definitions (can also be pulled from config.yaml)
        vms:
          - name: pxe-server
            vmid: 100
            ip: "{{ network.pxe_server }}"
            memory: "{{ resources.pxe_server.memory }}"
            cores: "{{ resources.pxe_server.cores }}"
            disk: "{{ resources.pxe_server.disk }}"
            role: pxe

          - name: lancache-server
            vmid: 101
            ip: "{{ network.lancache_server }}"
            memory: "{{ resources.lancache_server.memory }}"
            cores: "{{ resources.lancache_server.cores }}"
            disk: "{{ resources.lancache_server.disk }}"
            extra_disk: "{{ resources.lancache_server.cache_disk }}"
            role: lancache

          - name: file-server
            vmid: 102
            ip: "{{ network.file_server }}"
            memory: "{{ resources.file_server.memory }}"
            cores: "{{ resources.file_server.cores }}"
            disk: "{{ resources.file_server.disk }}"
            extra_disk: "{{ resources.file_server.data_disk }}"
            role: fileserver

# Imported playbooks
- import_playbook: provision/display_deployment_info.yml
- import_playbook: provision/template.yml
- import_playbook: provision/clone_vms.yml
- import_playbook: provision/wait_for_ssh.yml
- import_playbook: provision/update_dns.yml
- import_playbook: provision/install_agent.yml
- import_playbook: provision/build_inventory.yml
